<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityVibe AI - –£–º–Ω–∞—è –∫–∞—Ä—Ç–∞ –≥–æ—Ä–æ–¥–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #0B3D91;
            --primary-glow: rgba(11, 61, 145, 0.4);
            --accent: #4CAF50;
            --accent-glow: rgba(76, 175, 80, 0.4);
            --glass: rgba(255, 255, 255, 0.92);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            --r: 20px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: #000;
        }

        /* ‚îÄ‚îÄ Welcome ‚îÄ‚îÄ */
        #welcome-overlay {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: radial-gradient(circle at center, #0B3D91 0%, #000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            text-align: center;
            transition: all .8s cubic-bezier(.4, 0, .2, 1);
        }

        #welcome-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            transform: scale(1.1);
        }

        .welcome-content h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 5rem;
            margin: 0;
            letter-spacing: -2px;
            background: linear-gradient(to bottom, #fff, #a5c9ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: heroFade 1.2s ease-out;
        }

        @keyframes heroFade {
            from {
                opacity: 0;
                transform: translateY(20px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .welcome-content p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, .7);
            margin: 20px 0 40px;
            max-width: 640px;
            line-height: 1.6;
        }

        .start-btn {
            padding: 18px 56px;
            font-size: 1.15rem;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            box-shadow: 0 8px 25px var(--accent-glow);
            transition: all .3s cubic-bezier(.175, .885, .32, 1.275);
        }

        .start-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 14px 35px var(--accent-glow);
        }

        /* ‚îÄ‚îÄ Map ‚îÄ‚îÄ */
        #map {
            flex-grow: 1;
            height: 100%;
            z-index: 1;
        }

        /* ‚îÄ‚îÄ Search Box ‚îÄ‚îÄ */
        #search-box {
            position: absolute;
            top: 24px;
            left: 24px;
            z-index: 999;
            width: 440px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: var(--glass-border);
            border-radius: var(--r);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .search-row {
            display: flex;
            align-items: center;
            padding: 0 20px;
            height: 62px;
        }

        #search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
            font-weight: 500;
        }

        #user-type-select {
            appearance: none;
            border: none;
            background: #f0f4ff;
            color: var(--primary);
            padding: 9px 18px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            outline: none;
        }

        /* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
        #tool-bar {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 999;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .tool-btn {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: var(--glass-border);
            padding: 11px 22px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all .3s;
        }

        .tool-btn:hover {
            transform: translateY(-2px);
        }

        .tool-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        #lang-btn {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: var(--glass-border);
            padding: 10px 16px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all .3s;
        }

        #lang-btn:hover {
            transform: translateY(-2px);
        }

        /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            backdrop-filter: blur(8px);
            z-index: 20001;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .scanner-circle {
            width: 120px;
            height: 120px;
            border: 4px solid rgba(76, 175, 80, .2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #loading-text {
            color: #fff;
            margin-top: 22px;
            font-weight: 700;
            letter-spacing: 2px;
            font-size: 13px;
        }

        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
        #sidebar {
            position: absolute;
            top: 108px;
            left: 24px;
            z-index: 998;
            width: 440px;
            background: var(--glass);
            backdrop-filter: blur(25px);
            border: var(--glass-border);
            border-radius: var(--r);
            box-shadow: var(--shadow);
            max-height: calc(100vh - 148px);
            overflow-y: auto;
            display: none;
            animation: sideSlide .4s cubic-bezier(.2, 1, .3, 1);
        }

        @keyframes sideSlide {
            from {
                transform: translateX(-40px);
                opacity: 0
            }

            to {
                transform: translateX(0);
                opacity: 1
            }
        }

        .sb-header {
            padding: 28px 28px 20px;
            background: rgba(11, 61, 145, .05);
            border-bottom: 1px solid rgba(0, 0, 0, .05);
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            font-size: 26px;
            color: #999;
            cursor: pointer;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            background: var(--primary);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 16px;
            box-shadow: 0 8px 20px var(--primary-glow);
        }

        .content-pad {
            padding: 20px 28px 28px;
        }

        /* ‚îÄ‚îÄ Infra cards ‚îÄ‚îÄ */
        .infra-card {
            display: flex;
            align-items: center;
            padding: 13px 14px;
            background: #fff;
            border-radius: 13px;
            margin-bottom: 9px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .04);
            border: 1px solid rgba(0, 0, 0, .05);
            transition: all .2s;
        }

        .infra-card:hover {
            transform: translateX(4px);
            border-color: var(--primary);
        }

        .find-btn {
            background: #f0f4ff;
            color: var(--primary);
            border: none;
            border-radius: 9px;
            padding: 5px 11px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .find-btn:hover {
            background: var(--primary);
            color: #fff;
        }

        /* ‚îÄ‚îÄ Infra category headers ‚îÄ‚îÄ */
        .infra-cat-header {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #aaa;
            font-weight: 700;
            margin: 14px 0 6px;
            padding-left: 4px;
        }

        /* ‚îÄ‚îÄ Chat ‚îÄ‚îÄ */
        #chat-widget {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 10002;
        }

        #chat-bubble {
            width: 64px;
            height: 64px;
            background: var(--primary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 10px 30px var(--primary-glow);
            transition: all .3s;
        }

        #chat-bubble:hover {
            transform: scale(1.1) rotate(5deg);
        }

        #chat-window {
            position: absolute;
            bottom: 85px;
            right: 0;
            width: 380px;
            height: 520px;
            background: #fff;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .chat-hdr {
            padding: 18px 20px;
            background: var(--primary);
            color: #fff;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
        }

        .chat-msgs {
            flex: 1;
            padding: 18px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 13px;
            background: #fcfdfe;
        }

        .msg-ai {
            background: #f0f2f5;
            align-self: flex-start;
            border-radius: 15px 15px 15px 4px;
            padding: 11px 15px;
            font-size: 14px;
            color: #444;
            line-height: 1.5;
            max-width: 88%;
        }

        .msg-user {
            background: var(--primary);
            color: #fff;
            align-self: flex-end;
            border-radius: 15px 15px 4px 15px;
            padding: 11px 15px;
            font-size: 14px;
            box-shadow: 0 4px 12px var(--primary-glow);
            max-width: 88%;
        }

        .msg-ai p {
            margin: 6px 0;
        }

        .msg-ai p:first-child {
            margin-top: 0;
        }

        .msg-ai p:last-child {
            margin-bottom: 0;
        }

        .msg-ai ul,
        .msg-ai ol {
            margin: 6px 0;
            padding-left: 18px;
        }

        .chat-input-row {
            padding: 14px 18px;
            border-top: 1px solid #f0f0f0;
            background: #fff;
            display: flex;
            gap: 10px;
        }

        .chat-input-row input {
            flex: 1;
            border: 1px solid #e0e0e0;
            padding: 11px 18px;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }

        .chat-send {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 14px;
            padding: 0 18px;
            cursor: pointer;
            font-size: 18px;
        }

        /* ‚îÄ‚îÄ Typing indicator ‚îÄ‚îÄ */
        .typing-dot-wrap {
            background: #f0f2f5;
            align-self: flex-start;
            border-radius: 15px 15px 15px 4px;
            padding: 14px 18px;
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .typing-dot-wrap span {
            width: 8px;
            height: 8px;
            background: #bbb;
            border-radius: 50%;
            animation: tbounce 1.2s infinite ease-in-out;
        }

        .typing-dot-wrap span:nth-child(2) {
            animation-delay: .22s;
        }

        .typing-dot-wrap span:nth-child(3) {
            animation-delay: .44s;
        }

        @keyframes tbounce {

            0%,
            60%,
            100% {
                transform: translateY(0);
                background: #bbb;
            }

            30% {
                transform: translateY(-9px);
                background: var(--primary);
            }
        }

        /* ‚îÄ‚îÄ Compare floating panel ‚îÄ‚îÄ */
        #compare-panel {
            position: absolute;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: var(--glass-border);
            border-radius: 50px;
            box-shadow: var(--shadow);
            padding: 12px 24px;
            display: none;
            align-items: center;
            gap: 16px;
            white-space: nowrap;
            animation: fadeUp .3s ease;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px)
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0)
            }
        }

        #cmp-badge {
            background: var(--primary);
            color: #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 15px;
            flex-shrink: 0;
        }

        #cmp-analyze-btn {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 28px;
            padding: 9px 22px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all .2s;
        }

        #cmp-analyze-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #cmp-analyze-btn:not(:disabled):hover {
            transform: scale(1.05);
        }

        #cmp-clear-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            padding: 0 4px;
        }

        #cmp-clear-btn:hover {
            color: #555;
        }

        /* ‚îÄ‚îÄ Compare results ‚îÄ‚îÄ */
        .cmp-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 4px;
        }

        .cmp-card {
            background: #fff;
            border-radius: 14px;
            padding: 14px 12px;
            text-align: center;
            border: 2px solid #eee;
            transition: all .2s;
        }

        .cmp-card.winner {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, .15);
        }

        .cmp-score {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            font-weight: 800;
            color: #fff;
            margin: 0 auto 7px;
        }

        .cmp-label {
            font-size: 11px;
            color: #999;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .cmp-detail {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        /* ‚îÄ‚îÄ Listing markers ‚îÄ‚îÄ */
        .l-p {
            transition: transform .2s, box-shadow .2s;
        }

        .l-p:hover {
            transform: scale(1.1) translateY(-5px);
            z-index: 1000 !important;
        }

        .residential-popup-btn {
            display: block;
            width: 100%;
            margin-top: 8px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 7px 0;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
        }

        .residential-popup-btn:hover {
            background: #1a56c4;
        }

        /* ‚îÄ‚îÄ Building Polygons styles ‚îÄ‚îÄ */
        .building-poly {
            transition: all 0.3s ease;
            cursor: pointer;
            outline: none;
        }

        .building-poly:hover {
            fill-opacity: 0.3 !important;
            stroke-width: 5 !important;
            stroke-opacity: 1 !important;
        }

        .building-poly.scanning {
            animation: polyPulse 1.5s infinite ease-in-out;
            stroke: #4CAF50 !important;
            fill: #4CAF50 !important;
        }

        @keyframes polyPulse {
            0% {
                stroke-width: 3;
                fill-opacity: 0.1;
            }

            50% {
                stroke-width: 8;
                fill-opacity: 0.4;
            }

            100% {
                stroke-width: 3;
                fill-opacity: 0.1;
            }
        }
    </style>
</head>

<body>

    <!-- Welcome -->
    <div id="welcome-overlay">
        <div class="welcome-content">
            <h1>CityVibe AI</h1>
            <p id="w-desc">–£–º–Ω–∞—è –∫–∞—Ä—Ç–∞ –≤–∞—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞. –£–∑–Ω–∞–π—Ç–µ, –Ω–∞—Å–∫–æ–ª—å–∫–æ —É–¥–æ–±–µ–Ω —Ä–∞–π–æ–Ω –¥–ª—è –∂–∏–∑–Ω–∏.</p>
            <div style="display:flex;gap:12px;justify-content:center;margin-bottom:24px;">
                <button id="w-lang-ru" onclick="setLangWelcome('ru')"
                    style="background:rgba(255,255,255,0.15);color:#fff;border:2px solid rgba(255,255,255,0.6);padding:8px 22px;border-radius:30px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;">üá∑üá∫
                    –†—É—Å—Å–∫–∏–π</button>
                <button id="w-lang-en" onclick="setLangWelcome('en')"
                    style="background:transparent;color:rgba(255,255,255,0.6);border:2px solid rgba(255,255,255,0.25);padding:8px 22px;border-radius:30px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;">üá¨üáß
                    English</button>
            </div>
            <button class="start-btn" onclick="startApp()" id="w-btn">–ù–∞—á–∞—Ç—å</button>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading-overlay">
        <div class="scanner-circle"></div>
        <div id="loading-text" style="color:#fff;margin-top:22px;font-weight:700;letter-spacing:2px;font-size:13px;">
            –ê–ù–ê–õ–ò–ó...</div>
        <button id="cancel-audit-btn" onclick="cancelAudit()"
            style="margin-top:20px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.3);padding:8px 20px;border-radius:20px;font-size:12px;cursor:pointer;backdrop-filter:blur(5px);">
            –û—Ç–º–µ–Ω–∏—Ç—å</button>
    </div>

    <!-- Search -->
    <div id="search-box">
        <div class="search-row">
            <span style="font-size:22px;margin-right:14px;">üîç</span>
            <input type="text" id="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ">
            <select id="user-type-select">
                <option value="resident">üè† –ñ–∏—Ç–µ–ª—å</option>
                <option value="student">üéì –°—Ç—É–¥–µ–Ω—Ç</option>
                <option value="business">üíº –ë–∏–∑–Ω–µ—Å</option>
            </select>
        </div>
        <div id="search-results"></div>
    </div>

    <!-- Toolbar -->
    <div id="tool-bar">
        <button class="tool-btn" id="compare-toggle" onclick="toggleCompare()">‚öñÔ∏è <span
                id="tb-cmp">–°—Ä–∞–≤–Ω–∏—Ç—å</span></button>
        <button class="tool-btn" id="listings-toggle" onclick="toggleListings()">üè¢ <span
                id="tb-re">–ñ–∏–ª—å—ë</span></button>
        <button id="lang-btn" onclick="toggleLang()">üá¨üáß EN</button>
    </div>

    <div id="map"></div>

    <!-- Compare floating panel -->
    <div id="compare-panel">
        <div id="cmp-badge">0</div>
        <span id="cmp-hint">–ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–∞</span>
        <button id="cmp-analyze-btn" onclick="startCompareAnalysis()" disabled>üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ</button>
        <button id="cmp-clear-btn" onclick="clearCompare()" title="–°–±—Ä–æ—Å–∏—Ç—å">‚úï</button>
    </div>

    <!-- Chat widget -->
    <div id="chat-widget">
        <div id="chat-window">
            <div class="chat-hdr">
                <span id="chat-title">üí¨ –°–ø—Ä–æ—Å–∏—Ç—å –æ —Ä–∞–π–æ–Ω–µ</span>
                <span style="cursor:pointer;font-size:22px;" onclick="toggleChat()">√ó</span>
            </div>
            <div class="chat-msgs" id="chat-messages">
                <div class="msg-ai" id="chat-greeting">–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ ‚Äî —è —Ä–∞—Å—Å–∫–∞–∂—É –æ –Ω—ë–º –≤—Å—ë!
                </div>
            </div>
            <div class="chat-input-row">
                <input type="text" id="chat-input" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å..."
                    onkeydown="if(event.key==='Enter') sendChatMessage()">
                <button class="chat-send" onclick="sendChatMessage()">‚û°Ô∏è</button>
            </div>
        </div>
        <div id="chat-bubble" onclick="toggleChat()">ü§ñ</div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar">
        <div class="sb-header">
            <button class="close-btn" onclick="closeSidebar()">√ó</button>
            <button id="back-to-compare" onclick="showView('compare')"
                style="display:none;position:absolute;top:16px;left:16px;background:var(--primary);color:#fff;border:none;padding:5px 12px;border-radius:15px;font-size:12px;font-weight:700;cursor:pointer;z-index:10;">
                ‚Üê –ù–∞–∑–∞–¥</button>
            <div id="hdr-normal">
                <div class="score-circle" id="score-box">--</div>
                <h3 id="addr-title" style="margin:0 0 4px;">–û–±—ä–µ–∫—Ç</h3>
                <span style="font-size:12px;color:#999;" id="score-label">–û—Ü–µ–Ω–∫–∞ —Ä–∞–π–æ–Ω–∞</span>
            </div>
            <div id="hdr-compare" style="display:none;">
                <h3 style="margin:0 0 14px;font-family:'Outfit'" id="cmp-header-title">‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Å—Ç</h3>
                <div class="cmp-grid" id="cmp-results-grid"></div>
                <div id="cmp-winner-text"
                    style="margin-top:14px;padding:13px 16px;background:#e8f5e9;border-radius:14px;font-size:14px;color:#2e7d32;font-weight:600;text-align:center;">
                </div>
            </div>
        </div>
        <div class="content-pad">
            <div id="normal-view">
                <div id="verdict-text"
                    style="margin-bottom:18px;padding:14px;border-radius:12px;background:#f8f9fa;font-size:14px;border-left:5px solid var(--primary)">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:13px;">
                    <div style="background:#e8f5e9;padding:14px;border-radius:14px;text-align:center">
                        <div style="font-size:10px;text-transform:uppercase;color:#2e7d32;font-weight:700"
                            id="green-lbl">üåø –ó–µ–ª—ë–Ω—ã–µ –∑–æ–Ω—ã</div>
                        <div id="ndvi-val" style="font-size:24px;font-weight:800;color:#2e7d32">--</div>
                    </div>
                    <div style="background:#e3f2fd;padding:14px;border-radius:14px;text-align:center">
                        <div style="font-size:10px;text-transform:uppercase;color:#1565c0;font-weight:700"
                            id="nearby-lbl">üìç –†—è–¥–æ–º</div>
                        <div id="obj-count" style="font-size:24px;font-weight:800;color:#1565c0">--</div>
                    </div>
                </div>
                <button onclick="getAIAdvice()" id="ask-ai-btn"
                    style="width:100%;margin-top:18px;padding:15px;background:linear-gradient(45deg,var(--primary),#2d5dbd);color:#fff;border:none;border-radius:14px;font-weight:700;cursor:pointer;box-shadow:0 5px 15px var(--primary-glow)">
                    ü§ñ –°–ø—Ä–æ—Å–∏—Ç—å –ø–æ–º–æ—â–Ω–∏–∫–∞
                </button>
                <h4 id="infra-hdr"
                    style="margin:26px 0 10px;font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;">
                    –ß—Ç–æ –µ—Å—Ç—å —Ä—è–¥–æ–º (–ø–µ—à–∫–æ–º)</h4>
                <div id="infra-container"></div>
            </div>
            <div id="compare-view" style="display:none;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 1. TRANSLATIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const LANG = {
            ru: {
                wDesc: '–£–º–Ω–∞—è –∫–∞—Ä—Ç–∞ –≤–∞—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞. –£–∑–Ω–∞–π—Ç–µ, –Ω–∞—Å–∫–æ–ª—å–∫–æ —É–¥–æ–±–µ–Ω —Ä–∞–π–æ–Ω –¥–ª—è –∂–∏–∑–Ω–∏.',
                wBtn: '–ù–∞—á–∞—Ç—å',
                search: '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ',
                optRes: 'üè† –ñ–∏—Ç–µ–ª—å', optStu: 'üéì –°—Ç—É–¥–µ–Ω—Ç', optBiz: 'üíº –ë–∏–∑–Ω–µ—Å',
                btnCmp: '–°—Ä–∞–≤–Ω–∏—Ç—å', btnRe: '–ñ–∏–ª—å—ë', langBtn: 'üá∑üá∫ –†–£',
                chatTitle: 'üí¨ –°–ø—Ä–æ—Å–∏—Ç—å –æ —Ä–∞–π–æ–Ω–µ',
                chatPlaceholder: '–í–∞—à –≤–æ–ø—Ä–æ—Å...',
                chatGreeting: '–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ ‚Äî —è —Ä–∞—Å—Å–∫–∞–∂—É –æ –Ω—ë–º –≤—Å—ë!',
                scoreLabel: '–û—Ü–µ–Ω–∫–∞ —Ä–∞–π–æ–Ω–∞',
                greenLbl: 'üåø –ó–µ–ª—ë–Ω—ã–µ –∑–æ–Ω—ã',
                nearbyLbl: 'üìç –†—è–¥–æ–º',
                askAi: 'ü§ñ –°–ø—Ä–æ—Å–∏—Ç—å –ø–æ–º–æ—â–Ω–∏–∫–∞',
                infraHdr: '–ß—Ç–æ –µ—Å—Ç—å —Ä—è–¥–æ–º (–ø–µ—à–∫–æ–º)',
                findOnMap: 'üìç –ù–∞ –∫–∞—Ä—Ç–µ',
                cmpHeader: '‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Å—Ç',
                cmpAnalyze: 'üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ',
                cmpWinner: 'üèÜ –õ—É—á—à–µ–µ –º–µ—Å—Ç–æ',
                cmpHint: '–ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Å—Ç–∞',
                cmpSelected: n => `–í—ã–±—Ä–∞–Ω–æ: ${n} –∏–∑ 10`,
                ratingGood: 'üèôÔ∏è –û—Ç–ª–∏—á–Ω—ã–π —Ä–∞–π–æ–Ω!',
                ratingOk: '‚öñÔ∏è –ù–µ–ø–ª–æ—Ö–æ–π —Ä–∞–π–æ–Ω.',
                ratingBad: 'üõë –ï—Å—Ç—å –Ω–∞–¥ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å.',
                walkMin: '–º–∏–Ω',
                errServer: '‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ server.py!',
                errChoose: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ.',
                loading: '–ê–ù–ê–õ–ò–ó...',
                rateArea: 'üìä –ü–æ–¥—Ä–æ–±–Ω–µ–µ',
                spot: '–ú–µ—Å—Ç–æ', spots: '–æ–±—ä–µ–∫—Ç', points: '–±–∞–ª–ª–æ–≤',
                errClickBuilding: '‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∑–¥–∞–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.',
                cmpModOn: '–†–µ–∂–∏–º —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–∫–ª—é—á—ë–Ω! –ù–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ 10 –º–µ—Å—Ç, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ¬ª.',
                catNames: { 0: 'üõí –ú–∞–≥–∞–∑–∏–Ω—ã', 1: 'üíä –ê–ø—Ç–µ–∫–∏', 2: '‚òï –ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã', 3: 'üè• –ö–ª–∏–Ω–∏–∫–∏', 4: 'üöå –û—Å—Ç–∞–Ω–æ–≤–∫–∏' }
            },
            en: {
                wDesc: 'Smart city map. Find out how convenient a neighborhood is for living.',
                wBtn: 'Get Started',
                search: 'Enter address or click on the map',
                optRes: 'üè† Resident', optStu: 'üéì Student', optBiz: 'üíº Business',
                btnCmp: 'Compare', btnRe: 'Housing', langBtn: 'üá¨üáß EN',
                chatTitle: 'üí¨ Ask about this area',
                chatPlaceholder: 'Your question...',
                chatGreeting: 'Hi! Click anywhere on the map and I\'ll tell you all about it!',
                scoreLabel: 'Neighborhood Score',
                greenLbl: 'üåø Green Zones',
                nearbyLbl: 'üìç Nearby',
                askAi: 'ü§ñ Ask Assistant',
                infraHdr: 'Nearby places (walkable)',
                findOnMap: 'üìç Show on map',
                cmpHeader: '‚öñÔ∏è Compare Areas',
                cmpAnalyze: 'üîç Analyze All',
                cmpWinner: 'üèÜ Best spot',
                cmpHint: 'Click on the map to add spots',
                cmpSelected: n => `Selected: ${n} of 10`,
                ratingGood: 'üèôÔ∏è Great neighborhood!',
                ratingOk: '‚öñÔ∏è Decent area.',
                ratingBad: 'üõë Needs improvement.',
                walkMin: 'min',
                errServer: '‚ùå Server unavailable. Run server.py!',
                errChoose: 'First select a location on the map.',
                loading: 'ANALYZING...',
                rateArea: 'üìä Details',
                spot: 'Spot', spots: 'places', points: 'points',
                errClickBuilding: '‚ö†Ô∏è Please click on a building to analyze.',
                cmpModOn: 'Compare mode on! Click on the map to select up to 10 spots, then press Analyze All.',
                catNames: { 0: 'üõí Shops', 1: 'üíä Pharmacies', 2: '‚òï Cafes & Restaurants', 3: 'üè• Clinics', 4: 'üöå Bus Stops' }
            }
        };

        let lang = 'ru';
        function t(k) { return LANG[lang][k] || LANG['ru'][k] || k; }

        function toggleLang() {
            lang = lang === 'ru' ? 'en' : 'ru';
            applyLang();
        }

        function setLangWelcome(newLang) {
            lang = newLang;
            // Update welcome buttons styles
            const activeStyle = 'background:rgba(255,255,255,0.15);color:#fff;border:2px solid rgba(255,255,255,0.6);padding:8px 22px;border-radius:30px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;';
            const inactiveStyle = 'background:transparent;color:rgba(255,255,255,0.6);border:2px solid rgba(255,255,255,0.25);padding:8px 22px;border-radius:30px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;';
            document.getElementById('w-lang-ru').style.cssText = lang === 'ru' ? activeStyle : inactiveStyle;
            document.getElementById('w-lang-en').style.cssText = lang === 'en' ? activeStyle : inactiveStyle;
            applyLang();
        }

        function applyLang() {
            document.getElementById('lang-btn').textContent = t('langBtn');
            document.getElementById('w-desc').textContent = t('wDesc');
            document.getElementById('w-btn').textContent = t('wBtn');
            document.getElementById('search-input').placeholder = t('search');
            document.getElementById('user-type-select').options[0].text = t('optRes');
            document.getElementById('user-type-select').options[1].text = t('optStu');
            document.getElementById('user-type-select').options[2].text = t('optBiz');
            document.getElementById('tb-cmp').textContent = t('btnCmp');
            document.getElementById('tb-re').textContent = t('btnRe');
            document.getElementById('chat-title').textContent = t('chatTitle');
            document.getElementById('chat-input').placeholder = t('chatPlaceholder');
            document.getElementById('chat-greeting').textContent = t('chatGreeting');
            document.getElementById('score-label').textContent = t('scoreLabel');
            document.getElementById('green-lbl').textContent = t('greenLbl');
            document.getElementById('nearby-lbl').textContent = t('nearbyLbl');
            document.getElementById('ask-ai-btn').textContent = t('askAi');
            document.getElementById('infra-hdr').textContent = t('infraHdr');
            document.getElementById('cmp-header-title').textContent = t('cmpHeader');
            document.getElementById('loading-text').textContent = t('loading');
            document.getElementById('cmp-analyze-btn').textContent = t('cmpAnalyze');
            updateComparePanelUI();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 2. GLOBAL STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let map, scoreMarker, listingsLayer, polyLayer, infraMarkers = [];
        let currentAuditData = null;
        let isCompareMode = false;
        let comparePins = [];     // [{latlng, marker, data}]
        let auditAbortController = null;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 3. INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function initApp() {
            map = L.map('map', { zoomControl: false }).setView([51.247, 51.415], 15);
            // NOTE: –∏—Å–ø–æ–ª—å–∑—É–µ–º Google Satellite tiles —Å –ø–æ–¥–ø–∏—Å—å—é ‚Äî –ª—É—á—à–µ —á—Ç–∏–º–æ—Å—Ç—å –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤
            // fix: –¥–æ–±–∞–≤–∏–ª attribution, –∏–Ω–∞—á–µ –∫–∞—Ä—Ç–∞ –º–æ–∂–µ—Ç –Ω–µ –≥—Ä—É–∑–∏—Ç—å—Å—è –∏–∑-–∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è ToS
            L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 20, subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: '&copy; Google'
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            polyLayer = L.layerGroup().addTo(map); // –°–ª–æ–π –¥–ª—è –∫–æ–Ω—Ç—É—Ä–æ–≤ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω)
            listingsLayer = L.layerGroup().addTo(map); // –°–ª–æ–π –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ —Ü–µ–Ω

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç—É—Ä—ã –≤—Å–µ—Ö –∑–¥–∞–Ω–∏–π —Å—Ä–∞–∑—É
            loadAllBuildings();

            // Debounced update for buildings
            let moveTimeout;
            map.on('moveend', () => {
                clearTimeout(moveTimeout);
                moveTimeout = setTimeout(loadAllBuildings, 1000);
            });

            // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–µ–∫)
            // NOTE: –∞—É–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫–æ–Ω—Ç—É—Ä –∑–¥–∞–Ω–∏—è, –Ω–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ
            map.on('click', (e) => {
                if (isCompareMode) {
                    addComparePin(e.latlng);
                }
                // –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –∫–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ—Ç–µ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç
                // –ê—É–¥–∏—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –ø–æ–ª–∏–≥–æ–Ω –∑–¥–∞–Ω–∏—è
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 4. UI HELPERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function startApp() { document.getElementById('welcome-overlay').classList.add('hidden'); }
        function closeSidebar() { document.getElementById('sidebar').style.display = 'none'; }
        function toggleChat() {
            const w = document.getElementById('chat-window');
            w.style.display = w.style.display === 'flex' ? 'none' : 'flex';
        }
        function showView(view) {
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('normal-view').style.display = view === 'normal' ? 'block' : 'none';
            document.getElementById('compare-view').style.display = view === 'compare' ? 'block' : 'none';
            document.getElementById('hdr-normal').style.display = view === 'normal' ? 'block' : 'none';
            document.getElementById('hdr-compare').style.display = view === 'compare' ? 'block' : 'none';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥", –µ—Å–ª–∏ –º—ã –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –≤–∏–¥–µ, –Ω–æ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const hasCmp = comparePins.some(p => p.data);
            document.getElementById('back-to-compare').style.display = (view === 'normal' && hasCmp) ? 'block' : 'none';
            if (view === 'normal' && hasCmp) {
                document.querySelector('.close-btn').style.display = 'none';
            } else {
                document.querySelector('.close-btn').style.display = 'block';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 4.5. MAP CLICK HANDLER ‚Äî –∞—É–¥–∏—Ç –ª—é–±–æ–π —Ç–æ—á–∫–∏
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function handleMapClick(latlng) {
            const lat = latlng.lat;
            const lon = latlng.lng;
            
            // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–µ–µ –∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Overpass
            showLoader(true);
            try {
                const query = `[out:json][timeout:10];
                    (
                      way["building"](around:50,${lat},${lon});
                      relation["building"](around:50,${lat},${lon});
                    );
                    out center geom;`;
                
                const res = await fetch("https://overpass-api.de/api/interpreter", {
                    method: "POST",
                    body: query
                });
                const data = await res.json();
                
                let bestBuilding = null;
                let minDist = Infinity;
                
                // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–µ–µ –∑–¥–∞–Ω–∏–µ
                for (const el of data.elements || []) {
                    let elLat, elLon;
                    if (el.center) {
                        elLat = el.center.lat;
                        elLon = el.center.lon;
                    } else if (el.lat && el.lon) {
                        elLat = el.lat;
                        elLon = el.lon;
                    } else continue;
                    
                    const dist = Math.sqrt(Math.pow(elLat - lat, 2) + Math.pow(elLon - lon, 2));
                    if (dist < minDist) {
                        minDist = dist;
                        bestBuilding = el;
                    }
                }
                
                if (bestBuilding && bestBuilding.geometry) {
                    // –†–∏—Å—É–µ–º –∫–æ–Ω—Ç—É—Ä –∑–¥–∞–Ω–∏—è
                    const geom = bestBuilding.geometry.map(p => [p.lat, p.lon]);
                    const poly = L.polygon(geom, {
                        color: '#4CAF50',
                        weight: 3,
                        opacity: 0.8,
                        fillColor: '#4CAF50',
                        fillOpacity: 0.15,
                        className: 'building-poly scanning'
                    }).addTo(polyLayer);
                    
                    // –¶–µ–Ω—Ç—Ä –∑–¥–∞–Ω–∏—è –¥–ª—è –∞—É–¥–∏—Ç–∞
                    const centerLat = bestBuilding.center?.lat || lat;
                    const centerLon = bestBuilding.center?.lon || lon;
                    
                    runAudit(centerLat, centerLon, { name: '–ó–¥–∞–Ω–∏–µ' }, L.latLng(centerLat, centerLon));
                } else {
                    // –ù–µ—Ç –∑–¥–∞–Ω–∏—è ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç–æ—á–∫–∞
                    runAudit(lat, lon, { name: '–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ' }, latlng);
                }
            } catch (e) {
                // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–µ–ª–∞–µ–º –∞—É–¥–∏—Ç —Ç–æ—á–∫–∏
                runAudit(lat, lon, { name: '–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ' }, latlng);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 5. TYPING INDICATOR
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showTyping() {
            removeTyping();
            const c = document.getElementById('chat-messages');
            const d = document.createElement('div');
            d.className = 'typing-dot-wrap'; d.id = 'typing-ind';
            d.innerHTML = '<span></span><span></span><span></span>';
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }
        function removeTyping() {
            const el = document.getElementById('typing-ind');
            if (el) el.remove();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 6. COMPARE MODE  (up to 10 pins)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const PIN_COLORS = ['#0B3D91', '#4CAF50', '#F44336', '#FF9800', '#9C27B0', '#00BCD4', '#E91E63', '#607D8B', '#795548', '#FF5722'];

        function toggleCompare() {
            isCompareMode = !isCompareMode;
            document.getElementById('compare-toggle').classList.toggle('active');
            if (isCompareMode) {
                clearCompare();
                document.getElementById('compare-panel').style.display = 'flex';
                updateComparePanelUI();
                appendMsg('ai', t('cmpModOn'));
            } else {
                clearCompare();
                document.getElementById('compare-panel').style.display = 'none';
            }
        }

        function addComparePin(latlng) {
            if (comparePins.length >= 10) return;
            const num = comparePins.length + 1;
            const color = PIN_COLORS[comparePins.length];
            const marker = L.marker([latlng.lat, latlng.lng], {
                icon: L.divIcon({
                    className: '',
                    html: `<div style="background:${color};color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;border:3px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,.3);">${num}</div>`,
                    iconSize: [32, 32], iconAnchor: [16, 16]
                })
            }).addTo(map);
            comparePins.push({ latlng, marker, data: null });
            updateComparePanelUI();
        }

        function clearCompare() {
            comparePins.forEach(p => { if (p.marker) map.removeLayer(p.marker); });
            comparePins = [];
            if (scoreMarker) { map.removeLayer(scoreMarker); scoreMarker = null; }
            updateComparePanelUI();
        }

        function updateComparePanelUI() {
            const n = comparePins.length;
            document.getElementById('cmp-badge').textContent = n;
            const hintEl = document.getElementById('cmp-hint');
            if (n === 0) {
                hintEl.textContent = t('cmpHint');
            } else {
                const fn = LANG[lang].cmpSelected;
                hintEl.textContent = typeof fn === 'function' ? fn(n) : `–í—ã–±—Ä–∞–Ω–æ: ${n}`;
            }
            const btn = document.getElementById('cmp-analyze-btn');
            btn.disabled = n < 2;
            btn.textContent = t('cmpAnalyze');
        }

        async function startCompareAnalysis() {
            if (comparePins.length < 2) return;
            showLoader(true);
            const utype = document.getElementById('user-type-select').value;
            try {
                const results = await Promise.all(
                    comparePins.map(p =>
                        fetch(`http://127.0.0.1:8000/audit?lat=${p.latlng.lat}&lon=${p.latlng.lng}&user_type=${utype}`)
                            .then(r => r.json())
                    )
                );
                results.forEach((d, i) => { comparePins[i].data = d.status === 'success' ? d : null; });
                showLoader(false);
                renderCompareResults();
                showView('compare');
            } catch (e) {
                showLoader(false);
                appendMsg('ai', t('errServer'));
            }
        }

        function renderCompareResults() {
            const grid = document.getElementById('cmp-results-grid');
            grid.innerHTML = '';
            const valid = comparePins.filter(p => p.data);
            if (!valid.length) return;
            const sorted = [...valid].sort((a, b) => b.data.score - a.data.score);
            const winnerPin = sorted[0];

            valid.forEach(pin => {
                const d = pin.data;
                const idx = comparePins.indexOf(pin);
                const isWinner = pin === winnerPin;
                const sc = d.score;
                const col = sc > 70 ? '#4CAF50' : sc > 40 ? '#FFC107' : '#F44336';
                const card = document.createElement('div');
                card.className = 'cmp-card' + (isWinner ? ' winner' : '');
                card.innerHTML = `
            <div class="cmp-label">${t('spot')} ${idx + 1} ${isWinner ? 'üèÜ' : ''}</div>
            <div class="cmp-score" style="background:${col}">${sc}</div>
            <div class="cmp-detail">üåø ${d.ndvi_percent}%</div>
            <div class="cmp-detail">üìç ${d.infrastructure?.length || 0} ${t('spots')}</div>
            <button onclick="runAuditFromPin(${idx})" style="margin-top:7px;background:#f0f4ff;color:var(--primary);border:none;border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;">${t('rateArea')}</button>
        `;
                grid.appendChild(card);
            });

            const winIdx = comparePins.indexOf(winnerPin) + 1;
            document.getElementById('cmp-winner-text').innerHTML =
                `${t('cmpWinner')}: <b>${t('spot')} ${winIdx}</b> ‚Äî ${winnerPin.data.score} ${t('points')}`;
        }

        async function runAuditFromPin(idx) {
            const pin = comparePins[idx];
            if (!pin) return;
            await runAudit(pin.latlng.lat, pin.latlng.lng, { name: `${t('spot')} ${idx + 1}` }, pin.latlng);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 7. AUDIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function runAudit(lat, lon, props, latlng) {
            const utype = document.getElementById('user-type-select').value;
            showLoader(true);

            if (auditAbortController) auditAbortController.abort();
            auditAbortController = new AbortController();

            try {
                const res = await fetch(`http://127.0.0.1:8000/audit?lat=${lat}&lon=${lon}&user_type=${utype}`, {
                    signal: auditAbortController.signal
                });
                const data = await res.json();
                if (data.status === 'success') {
                    data.user_type = utype;
                    currentAuditData = data;
                    displayAudit(data, props, latlng);
                    showView('normal');
                }
            } catch (e) {
                if (e.name !== 'AbortError') {
                    appendMsg('ai', t('errServer'));
                }
            } finally {
                showLoader(false);
                auditAbortController = null;
                // Remove scanning animation from all polygons
                document.querySelectorAll('.building-poly').forEach(p => p.classList.remove('scanning'));
            }
        }

        function cancelAudit() {
            if (auditAbortController) {
                auditAbortController.abort();
                showLoader(false);
                appendMsg('ai', 'üõë –ê–Ω–∞–ª–∏–∑ –æ—Ç–º–µ–Ω—ë–Ω.');
            }
        }

        function showLoader(on) {
            document.getElementById('loading').style.display = on ? 'flex' : 'none';
        }

        function createScoreMarker(latlng, score, label) {
            const col = score > 70 ? '#4CAF50' : score > 40 ? '#FFC107' : '#F44336';
            return L.marker([latlng.lat, latlng.lng], {
                icon: L.divIcon({
                    className: 'cs-pin',
                    html: `<div style="background:${col};color:#fff;padding:5px 13px;border-radius:20px;font-weight:800;border:3px solid #fff;box-shadow:0 8px 20px rgba(0,0,0,.3);font-size:16px;">${label || score}</div>`,
                    iconSize: [50, 35], iconAnchor: [25, 17]
                })
            }).addTo(map);
        }

        function displayAudit(data, props, latlng) {
            if (scoreMarker) map.removeLayer(scoreMarker);
            scoreMarker = createScoreMarker(latlng, data.score);

            // Clear old infra markers
            infraMarkers.forEach(m => map.removeLayer(m));
            infraMarkers = [];

            const sc = data.score;
            document.getElementById('score-box').innerText = sc;
            document.getElementById('score-box').style.background = sc > 70 ? '#4CAF50' : sc > 40 ? '#FFC107' : '#F44336';
            document.getElementById('addr-title').innerText = props.name || (lang === 'en' ? 'Location' : '–õ–æ–∫–∞—Ü–∏—è');
            document.getElementById('ndvi-val').innerText = data.ndvi_percent + '%';
            document.getElementById('obj-count').innerText = data.infrastructure ? data.infrastructure.length : 0;

            const verdict = sc > 75 ? t('ratingGood') : sc > 50 ? t('ratingOk') : t('ratingBad');
            document.getElementById('verdict-text').innerText = verdict;

            // Add subtle infra markers to map
            (data.infrastructure || []).forEach(obj => {
                if (!obj.lat || !obj.lon) return;
                const icons = { 0: 'üõí', 1: 'üíä', 2: '‚òï', 3: 'üè•', 4: 'üöå' };
                const m = L.marker([obj.lat, obj.lon], {
                    icon: L.divIcon({
                        className: '',
                        html: `<div style="background:#fff;border:2px solid #ddd;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,.15);">${icons[obj.class] || 'üìç'}</div>`,
                        iconSize: [28, 28], iconAnchor: [14, 14]
                    }),
                    zIndexOffset: -100
                }).addTo(map);
                m.bindPopup(`<b>${obj.name}</b><br>${obj.walk_time} ${t('walkMin')}`);
                infraMarkers.push(m);
            });

            renderInfraList(data.infrastructure || []);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // 8. INFRASTRUCTURE LIST (sorted + find on map)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderInfraList(infra) {
            const container = document.getElementById('infra-container');
            container.innerHTML = '';
            if (!infra.length) { container.innerHTML = '<p style="color:#aaa;font-size:14px;">–û–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>'; return; }

            // Sort: by class (category) then by walk_time
            const sorted = [...infra].sort((a, b) => a.class !== b.class ? a.class - b.class : a.walk_time - b.walk_time);

            const walkLabel = t('walkMin');
            const findLabel = t('findOnMap');
            const catNames = LANG[lang].catNames;

            let lastCat = -1;
            sorted.forEach(obj => {
                // Category header
                if (obj.class !== lastCat) {
                    lastCat = obj.class;
                    const hdr = document.createElement('div');
                    hdr.className = 'infra-cat-header';
                    hdr.textContent = catNames[obj.class] || 'üìç –ü—Ä–æ—á–µ–µ';
                    container.appendChild(hdr);
                }

                const card = document.createElement('div');
                card.className = 'infra-card';
                const hasCoords = obj.lat && obj.lon;
                card.innerHTML = `
            <div style="font-size:22px;margin-right:13px;">${({ 0: 'üõí', 1: 'üíä', 2: '‚òï', 3: 'üè•', 4: 'üöå' })[obj.class] || 'üìç'}</div>
            <div style="flex:1;min-width:0;">
                <div style="font-weight:700;color:#333;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${obj.name}">${obj.name}</div>
                <div style="font-size:12px;color:#999;">${obj.walk_time} ${walkLabel}</div>
            </div>
            ${hasCoords ? `<button class="find-btn" onclick="flyToInfra(${obj.lat},${obj.lon},'${obj.name.replace(/'/g, "\\'")}')">üìç ${findLabel.replace('üìç ', '')}</button>` : ''}
        `;
                container.appendChild(card);
            });
        }

        function flyToInfra(lat, lon, name) {
            map.flyTo([lat, lon], 18, { duration: 1.2 });
            L.popup({ autoPan: true })
                .setLatLng([lat, lon])
                .setContent(`<b>${name}</b>`)
                .openOn(map);
        }

        async function loadAllBuildings() {
            const center = map.getCenter();
            try {
                const query = `[out:json][timeout:25];
                    (
                      way["building"](around:800,${center.lat},${center.lng});
                      relation["building"](around:800,${center.lat},${center.lng});
                    );
                    out center geom;`;
                
                const res = await fetch("https://overpass-api.de/api/interpreter", {
                    method: "POST",
                    body: query
                });
                const data = await res.json();
                
                polyLayer.clearLayers();
                
                data.elements.forEach(el => {
                    let poly_geom = [];
                    if (el.type === 'way') {
                        poly_geom = el.geometry?.map(p => [p.lat, p.lon]) || [];
                    } else if (el.type === 'relation') {
                        const member = el.members?.find(m => m.type === 'way' && m.geometry);
                        if (member) {
                            poly_geom = member.geometry.map(p => [p.lat, p.lon]);
                        }
                    }
                    
                    if (!poly_geom.length) return;
                    
                    let el_lat, el_lon;
                    if (el.center) {
                        el_lat = el.center.lat;
                        el_lon = el.center.lon;
                    } else if (el.lat && el.lon) {
                        el_lat = el.lat;
                        el_lon = el.lon;
                    } else {
                        el_lat = poly_geom.reduce((sum, p) => sum + p[0], 0) / poly_geom.length;
                        el_lon = poly_geom.reduce((sum, p) => sum + p[1], 0) / poly_geom.length;
                    }
                    
                    const poly = L.polygon(poly_geom, {
                        color: '#007AFF',
                        weight: 2,                    // —Ç–æ–Ω—å—à–µ –¥–ª—è –º–µ–Ω—å—à–µ–π –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                        opacity: 0.85,
                        fillColor: '#007AFF',
                        fillOpacity: 0.08,
                        className: 'building-poly'
                    }).addTo(polyLayer);
                    
                    poly.on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        if (isCompareMode) {
                            addComparePin(e.latlng);
                        } else {
                            const pathEl = e.target.getElement?.() || e.target._path;
                            if (pathEl) pathEl.classList.add('scanning');
                            runAudit(el_lat, el_lon, { name: '–ó–¥–∞–Ω–∏–µ' }, e.latlng);
                        }
                    });
                });
            } catch (e) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–¥–∞–Ω–∏–π:', e); }
        }

        async function loadListings() {
            const center = map.getCenter();
            const listingsActive = document.getElementById('listings-toggle').classList.contains('active');
            if (!listingsActive) return;
            
            try {
                const res = await fetch(`http://127.0.0.1:8000/listings?lat=${center.lat}&lon=${center.lng}`);
                const data = await res.json();
                
                listingsLayer.clearLayers();

                data.listings.forEach(l => {
                    const col = l.score > 70 ? '#4CAF50' : '#F44336';
                    const borderCol = '#0B3D91';
                    const marker = L.marker([l.lat, l.lon], {
                        icon: L.divIcon({
                            className: 'l-p',
                            html: `<div style="overflow:visible;position:relative;display:inline-block;">
                            <div style="background:#fff;padding:6px 14px;border-radius:25px;border:4px solid ${borderCol};font-weight:800;font-size:13px;box-shadow:0 6px 18px rgba(11,61,145,0.35);white-space:nowrap;color:${borderCol};">üè† ${l.price}</div>
                            <div style="position:absolute;top:-10px;right:-10px;background:${col};color:#fff;border-radius:50%;width:22px;height:22px;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.3);">${l.score}</div>
                        </div>`,
                            iconSize: [130, 42], iconAnchor: [65, 21]
                        })
                    }).addTo(listingsLayer);

                    const floorText = l.floors && l.floors !== '?' ? ` ‚Ä¢ ${l.floors} —ç—Ç.` : '';
                    const addrText = l.address ? `<br><small style="color:#999;">${l.address}</small>` : '';
                    const linkBtn = l.url ? `<a href="${l.url}" target="_blank" class="residential-popup-btn" style="flex:1;text-decoration:none;text-align:center;background:#0B3D91;">üîó –û–±—ä—è–≤–ª–µ–Ω–∏–µ</a>` : '';
                    const popupHtml = `
                        <b>${l.title}</b>${floorText}${addrText}
                        <br>–¶–µ–Ω–∞: <b>${l.price}</b>
                        <br>–û—Ü–µ–Ω–∫–∞ —Ä–∞–π–æ–Ω–∞: <b style="color:${col}">${l.score}/100</b>
                        <br><div style="display:flex;gap:5px;margin-top:8px;">
                            <button class="residential-popup-btn" style="flex:1;" onclick="rateListingArea(${l.lat},${l.lon})">üìä –ê–Ω–∞–ª–∏–∑</button>
                            ${linkBtn}
                        </div>
                    `;
                    marker.bindPopup(popupHtml);
                });
            } catch (e) { console.error(e); }
        }

        function rateListingArea(lat, lon) {
            map.closePopup();
            runAudit(lat, lon, { name: '–ñ–∏–ª–æ–π –¥–æ–º' }, L.latLng(lat, lon));
        }

        async function sendChatMessage() {
            const msg = document.getElementById('chat-input').value.trim();
            if (msg) {
                appendMsg('user', msg);
                document.getElementById('chat-input').value = '';
                showTyping();
                await getAIAdvice(msg);
            } else {
                appendMsg('ai', t('errChoose'));
            }
        }

        function appendMsg(role, text) {
            const c = document.getElementById('chat-messages');
            const d = document.createElement('div');
            d.className = `msg-${role}`;
            if (role === 'ai') { d.innerHTML = marked.parse(text); } else { d.innerText = text; }
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }

        async function getAIAdvice(customQ = null) {
            if (!currentAuditData) return;
            if (!customQ) { toggleChat(); showTyping(); }
            try {
                const res = await fetch('http://127.0.0.1:8000/explain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentAuditData)
                });
                const data = await res.json();
                removeTyping();
                appendMsg('ai', data.explanation || t('errServer'));
            } catch (e) {
                removeTyping();
                appendMsg('ai', t('errServer'));
            }
        }

        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>