<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>CityVibe AI - –£—Ä–∞–ª—å—Å–∫</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --google-blue: #1a73e8; --text-dark: #202124; }
        body { margin: 0; padding: 0; font-family: 'Roboto', Arial, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        #map { flex-grow: 1; height: 100%; position: relative; z-index: 1; }

        #search-box {
            position: absolute; top: 12px; left: 12px; z-index: 9999;
            width: 392px; background: white; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 -1px 0px rgba(0,0,0,0.02);
            display: flex; flex-direction: column; overflow: hidden;
        }

        .search-container { display: flex; align-items: center; padding: 0 16px; height: 48px; }
        .menu-icon { color: #70757a; margin-right: 16px; cursor: pointer; font-size: 20px; }
        
        #search-input {
            flex: 1; border: none; outline: none; font-size: 16px;
            color: var(--text-dark); background: transparent;
        }

        #search-results {
            background: white; border-top: 1px solid #e8eaed;
            max-height: 400px; overflow-y: auto; display: none;
        }

        .result-item {
            padding: 12px 16px; cursor: pointer; display: flex; align-items: center;
            border-bottom: 1px solid #f1f3f4; font-size: 14px; color: #3c4043;
        }
        .result-item:hover { background: #f8f9fa; }

        #sidebar { 
            position: absolute; top: 72px; left: 12px; z-index: 9998;
            width: 392px; background: white; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            max-height: calc(100vh - 100px); overflow-y: auto;
            display: none; padding: 0; color: var(--text-dark);
        }

        .sidebar-header { 
            background: #f8f9fa; padding: 20px; border-bottom: 1px solid #e8eaed;
            position: relative;
        }
        
        .close-sidebar {
            position: absolute; top: 16px; right: 16px;
            background: transparent; border: none; font-size: 24px;
            color: #70757a; cursor: pointer; padding: 4px 8px;
            border-radius: 4px; line-height: 1;
        }
        .close-sidebar:hover { background: #e8eaed; }
        .score-circle { 
            width: 60px; height: 60px; background: var(--google-blue); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold; margin-bottom: 10px;
        }

        .content-padding { padding: 20px; }
        h3 { margin: 0 0 8px 0; font-size: 22px; font-weight: 400; }
        .label { color: #70757a; font-size: 13px; margin-bottom: 15px; display: block; }

        .infra-card { 
            display: flex; align-items: center; padding: 12px 0;
            border-bottom: 1px solid #f1f3f4; font-size: 14px;
        }
        .infra-time { margin-left: auto; color: #188038; font-weight: 500; }
        
        .category-group { margin-bottom: 12px; }
        .category-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; cursor: pointer; user-select: none;
            border-bottom: 1px solid #e8eaed; font-weight: 500;
        }
        .category-header:hover { background: #f8f9fa; margin: 0 -20px; padding: 12px 20px; }
        .category-title { display: flex; align-items: center; gap: 8px; font-size: 15px; }
        .category-count { 
            background: #e8eaed; color: #5f6368; padding: 2px 8px; 
            border-radius: 12px; font-size: 12px; font-weight: 500;
        }
        .category-arrow { 
            font-size: 18px; transition: transform 0.2s; color: #70757a;
        }
        .category-arrow.open { transform: rotate(90deg); }
        .category-items { 
            display: none; padding-left: 8px; 
        }
        .category-items.open { display: block; }
        .category-items .infra-card { padding: 10px 0 10px 28px; }
        
        .location-btn {
            background: transparent; border: none; color: var(--google-blue);
            cursor: pointer; padding: 4px 8px; font-size: 18px;
            margin-left: 8px; border-radius: 4px;
        }
        .location-btn:hover { background: #e8f0fe; }
        
        .details-btn {
            background: #e8f0fe; border: none; color: var(--google-blue);
            cursor: pointer; padding: 6px 12px; font-size: 12px;
            border-radius: 4px; margin-left: 8px; font-weight: 500;
        }
        .details-btn:hover { background: #d2e3fc; }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ–±—ä–µ–∫—Ç–∞ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 10000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        
        .modal-content {
            background: white; border-radius: 12px; width: 90%;
            max-width: 600px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px; border-bottom: 1px solid #e8eaed;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { margin: 0; font-size: 20px; font-weight: 500; }
        
        .modal-body { padding: 0; }
        
        .place-photo {
            width: 100%; height: 250px; object-fit: cover;
            background: #f1f3f4; display: block;
        }
        
        .place-info { padding: 20px; }
        .place-rating {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 12px; font-size: 14px;
        }
        .stars { color: #fbbc04; }
        
        .place-hours {
            background: #f8f9fa; padding: 12px; border-radius: 8px;
            margin: 12px 0; font-size: 14px;
        }
        .place-hours-title { font-weight: 500; margin-bottom: 8px; }
        
        .place-reviews {
            margin-top: 16px; border-top: 1px solid #e8eaed; padding-top: 16px;
        }
        .review-item {
            padding: 12px 0; border-bottom: 1px solid #f1f3f4;
        }
        .review-author {
            font-weight: 500; font-size: 14px; margin-bottom: 4px;
        }
        .review-text {
            font-size: 13px; color: #5f6368; line-height: 1.5;
        }
        
        .score-marker {
            background: var(--google-blue); color: white;
            padding: 8px 12px; border-radius: 20px;
            font-weight: bold; font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 3px solid white;
        }

        .loading-overlay { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #323232; color: white; padding: 12px 24px;
            border-radius: 4px; z-index: 10000; display: none; font-size: 14px;
        }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">CityVibe AI analyzing...</div>

<div id="search-box">
    <div class="search-container">
        <span class="menu-icon">‚ò∞</span>
        <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –≤ CityVibe –£—Ä–∞–ª—å—Å–∫">
    </div>
    <div id="search-results"></div>
</div>

<div id="map"></div>

<div id="sidebar">
    <div class="sidebar-header">
        <button class="close-sidebar" onclick="closeSidebar()">√ó</button>
        <div class="score-circle" id="score-box">--</div>
        <h3 id="addr-title">–û–±—ä–µ–∫—Ç</h3>
        <span class="label">–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –≥–æ—Ä–æ–¥—Å–∫–æ–π —Å—Ä–µ–¥—ã</span>
    </div>
    <div class="content-padding">
        <p id="verdict-text" style="font-style: italic; color: #5f6368;"></p>
        <div style="margin-top: 20px;">
            <b>–û–∑–µ–ª–µ–Ω–µ–Ω–∏–µ (NDVI):</b> <span id="ndvi-val">--</span>
        </div>
        <h4 style="margin-top: 25px; font-size: 14px; text-transform: uppercase; color: #70757a;">–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏</h4>
        <div id="infra-container"></div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ–±—ä–µ–∫—Ç–∞ -->
<div class="modal-overlay" id="placeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <button class="close-sidebar" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <img id="modal-photo" class="place-photo" src="" alt="" style="display:none;">
            <div class="place-info">
                <div class="place-rating" id="modal-rating"></div>
                <div id="modal-address"></div>
                <div class="place-hours" id="modal-hours" style="display:none;">
                    <div class="place-hours-title">‚è∞ –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã</div>
                    <div id="modal-hours-list"></div>
                </div>
                <div class="place-reviews" id="modal-reviews" style="display:none;">
                    <h4 style="margin: 0 0 12px 0;">üí¨ –û—Ç–∑—ã–≤—ã</h4>
                    <div id="modal-reviews-list"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://tyrasd.github.io/osmtogeojson/osmtogeojson.js"></script>

<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ø—É—Ç–Ω–∏–∫–æ–≤–æ–π –∫–∞—Ä—Ç—ã Google –ë–ï–ó –º–µ—Ç–æ–∫ POI
    const map = L.map('map', { zoomControl: false }).setView([51.247, 51.415], 16);
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å—Ç—ã–π —Å–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π —Å–ª–æ–π –±–µ–∑ –º–µ—Ç–æ–∫ (lyrs=s)
    const googleSatellite = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);

    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // –ö—ç—à –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞—É–¥–∏—Ç–∞
    const auditCache = new Map();
    
    // –ú–∞—Ä–∫–µ—Ä —Å –±–∞–ª–ª–æ–º –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∑–¥–∞–Ω–∏–∏
    let scoreMarker = null;

    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');

    // –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞
    async function performSearch(query) {
        if (query.length < 3) return;
        const fullQuery = "–£—Ä–∞–ª—å—Å–∫, " + query;
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullQuery)}&limit=5&accept-language=ru`;

        try {
            const response = await fetch(url);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            if (!response.ok) {
                console.warn('Nominatim API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                return;
            }
            
            const data = await response.json();
            searchResults.innerHTML = '';
            if (data.length > 0) {
                searchResults.style.display = 'block';
                data.forEach(res => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.innerHTML = `üìç ${res.display_name.split(',').slice(0,2).join(',')}`;
                    div.onclick = () => {
                        const lat = parseFloat(res.lat);
                        const lon = parseFloat(res.lon);
                        map.setView([lat, lon], 18);
                        searchResults.style.display = 'none';
                        searchInput.value = res.display_name.split(',')[0];
                        runAudit(lat, lon, { "addr:street": searchInput.value }, { lat, lon });
                    };
                    searchResults.appendChild(div);
                });
            }
        } catch (e) { 
            console.warn('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', e.message); 
        }
    }

    searchInput.addEventListener('input', () => {
        clearTimeout(window.searchTimer);
        window.searchTimer = setTimeout(() => performSearch(searchInput.value), 500);
    });

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–¥–∞–Ω–∏–π
    let buildingsLayer = L.geoJSON(null, {
        style: { color: '#ffffff', weight: 1.5, fillOpacity: 0.1 },
        onEachFeature: (f, l) => {
            l.on('click', (e) => { 
                L.DomEvent.stopPropagation(e);
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;
                runAudit(lat, lon, f.properties, e.latlng); 
            });
        }
    }).addTo(map);

    async function loadBuildings() {
        if (map.getZoom() < 16) return;
        const b = map.getBounds();
        const q = `[out:json];(way["building"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out body;>;out skel qt;`;
        try {
            const res = await fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: q });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ JSON
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                console.warn('Overpass API –≤–µ—Ä–Ω—É–ª –Ω–µ JSON, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∑–¥–∞–Ω–∏–π');
                return;
            }
            
            const data = await res.json();
            if (data && data.elements) {
                buildingsLayer.clearLayers().addData(osmtogeojson(data));
            }
        } catch (e) { 
            console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–¥–∞–Ω–∏–π (Overpass API –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω):', e.message); 
        }
    }

    map.on('moveend', loadBuildings);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Overpass API
    let loadBuildingsTimeout;
    map.on('moveend', () => {
        clearTimeout(loadBuildingsTimeout);
        loadBuildingsTimeout = setTimeout(loadBuildings, 1000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 1 —Å–µ–∫—É–Ω–¥–∞
    });

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    window.toggleCategory = function(categoryId) {
        const items = document.getElementById(categoryId);
        const arrow = document.getElementById('arrow-' + categoryId);
        
        if (items && arrow) {
            items.classList.toggle('open');
            arrow.classList.toggle('open');
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
    window.showOnMap = function(lat, lon) {
        map.setView([lat, lon], 19, { animate: true, duration: 0.5 });
        
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä –Ω–∞ –æ–±—ä–µ–∫—Ç–µ
        const tempMarker = L.marker([lat, lon], {
            icon: L.divIcon({
                className: 'temp-marker',
                html: '<div style="background: #ea4335; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                iconSize: [20, 20]
            })
        }).addTo(map);
        
        // –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => map.removeLayer(tempMarker), 3000);
    };
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–∞–π–¥–±–∞—Ä–∞
    window.closeSidebar = function() {
        document.getElementById('sidebar').style.display = 'none';
    };
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    window.closeModal = function() {
        document.getElementById('placeModal').classList.remove('show');
    };
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('placeModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–µ–π –æ–±—ä–µ–∫—Ç–∞
    window.showPlaceDetails = async function(name, lat, lon) {
        const modal = document.getElementById('placeModal');
        modal.classList.add('show');
        
        // –°–±—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        document.getElementById('modal-title').innerText = name;
        document.getElementById('modal-photo').style.display = 'none';
        document.getElementById('modal-rating').innerHTML = '';
        document.getElementById('modal-address').innerHTML = '';
        document.getElementById('modal-hours').style.display = 'none';
        document.getElementById('modal-reviews').style.display = 'none';
        
        try {
            // –ó–∞–ø—Ä–æ—Å –∫ –±—ç–∫–µ–Ω–¥—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Places
            const res = await fetch(`http://127.0.0.1:8000/place-details?name=${encodeURIComponent(name)}&lat=${lat}&lon=${lon}`);
            const data = await res.json();
            
            if (data.status === 'success' && data.place) {
                const place = data.place;
                
                // –§–æ—Ç–æ
                if (place.photo_url) {
                    const photoEl = document.getElementById('modal-photo');
                    photoEl.src = place.photo_url;
                    photoEl.style.display = 'block';
                }
                
                // –†–µ–π—Ç–∏–Ω–≥
                if (place.rating) {
                    const stars = '‚≠ê'.repeat(Math.round(place.rating));
                    document.getElementById('modal-rating').innerHTML = `
                        <span class="stars">${stars}</span>
                        <span>${place.rating} (${place.user_ratings_total || 0} –æ—Ç–∑—ã–≤–æ–≤)</span>
                    `;
                }
                
                // –ê–¥—Ä–µ—Å
                if (place.address) {
                    document.getElementById('modal-address').innerHTML = `üìç ${place.address}`;
                }
                
                // –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã
                if (place.opening_hours && place.opening_hours.length > 0) {
                    document.getElementById('modal-hours').style.display = 'block';
                    document.getElementById('modal-hours-list').innerHTML = 
                        place.opening_hours.map(h => `<div style="padding: 4px 0;">${h}</div>`).join('');
                }
                
                // –û—Ç–∑—ã–≤—ã
                if (place.reviews && place.reviews.length > 0) {
                    document.getElementById('modal-reviews').style.display = 'block';
                    document.getElementById('modal-reviews-list').innerHTML = 
                        place.reviews.map(r => `
                            <div class="review-item">
                                <div class="review-author">
                                    <span class="stars">${'‚≠ê'.repeat(r.rating)}</span>
                                    ${r.author_name}
                                </div>
                                <div class="review-text">${r.text}</div>
                            </div>
                        `).join('');
                }
            } else {
                document.getElementById('modal-rating').innerHTML = 
                    '<p style="color: #70757a;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>';
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π:', e);
            document.getElementById('modal-rating').innerHTML = 
                '<p style="color: #d93025;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –ø–æ –∫–ª–∞—Å—Å—É –æ–±—ä–µ–∫—Ç–∞
    function getIconByClass(classId) {
        const icons = {
            0: 'üõí',  // –ú–∞–≥–∞–∑–∏–Ω
            1: 'üíä',  // –ê–ø—Ç–µ–∫–∞
            2: '‚òï',  // –ö–∞—Ñ–µ
            3: 'üè•',  // –ö–ª–∏–Ω–∏–∫–∞
            4: 'üöå'   // –û—Å—Ç–∞–Ω–æ–≤–∫–∞
        };
        return icons[classId] || 'üìç';
    }

    async function runAudit(lat, lon, props, latlng) {
        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫—ç—à–∞
        const cacheKey = `${lat.toFixed(6)}_${lon.toFixed(6)}`;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        if (auditCache.has(cacheKey)) {
            console.log('üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –∫—ç—à–∞');
            displayAuditResults(auditCache.get(cacheKey), props, latlng);
            return;
        }
        
        document.getElementById('loading').style.display = 'block';
        try {
            const res = await fetch(`http://127.0.0.1:8000/audit?lat=${lat}&lon=${lon}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
            if (!res.ok) {
                throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å ${res.status}`);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ server.py –∑–∞–ø—É—â–µ–Ω.');
            }
            
            const data = await res.json();
            
            if (data.status === "success") {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                auditCache.set(cacheKey, data);
                displayAuditResults(data, props, latlng);
            } else {
                alert('–û—à–∏–±–∫–∞ –∞—É–¥–∏—Ç–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (e) { 
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∞—É–¥–∏—Ç–∞:', e);
            alert("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É CityVibe\n\n" + 
                  "–£–±–µ–¥–∏—Å—å —á—Ç–æ:\n" +
                  "1. –ó–∞–ø—É—â–µ–Ω server.py (python server.py)\n" +
                  "2. –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ http://127.0.0.1:8000\n\n" +
                  "–î–µ—Ç–∞–ª–∏: " + e.message); 
        } finally { 
            document.getElementById('loading').style.display = 'none'; 
        }
    }
    
    function displayAuditResults(data, props, latlng) {
        document.getElementById('sidebar').style.display = 'block';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —Å –±–∞–ª–ª–æ–º –Ω–∞ –∑–¥–∞–Ω–∏–µ
        if (scoreMarker) {
            map.removeLayer(scoreMarker);
        }
        
        if (latlng) {
            const scoreColor = data.score > 70 ? '#188038' : (data.score > 40 ? '#1a73e8' : '#d93025');
            scoreMarker = L.marker([latlng.lat, latlng.lng], {
                icon: L.divIcon({
                    className: 'score-marker-container',
                    html: `<div class="score-marker" style="background: ${scoreColor}">${data.score}</div>`,
                    iconSize: [50, 30],
                    iconAnchor: [25, 15]
                })
            }).addTo(map);
            
            // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä —Å–Ω–æ–≤–∞
            scoreMarker.on('click', () => {
                document.getElementById('sidebar').style.display = 'block';
            });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–ª
        const scoreBox = document.getElementById('score-box');
        scoreBox.innerText = data.score;
        scoreBox.style.background = data.score > 70 ? '#188038' : (data.score > 40 ? '#1a73e8' : '#d93025');
        
        document.getElementById('addr-title').innerText = props["addr:street"] || props["name"] || "–í—ã–±—Ä–∞–Ω–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è";
        document.getElementById('ndvi-val').innerText = data.ndvi_percent + "%";
        
        // –í–µ—Ä–¥–∏–∫—Ç
        let verdict = "–í —ç—Ç–æ–º —Ä–∞–π–æ–Ω–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤.";
        if (data.score > 75) verdict = "–û—Ç–ª–∏—á–Ω–∞—è –≥–æ—Ä–æ–¥—Å–∫–∞—è —Å—Ä–µ–¥–∞!";
        else if (data.score > 50) verdict = "–•–æ—Ä–æ—à–∏–π —Ä–∞–π–æ–Ω, –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ —Ä—è–¥–æ–º.";
        document.getElementById('verdict-text').innerText = verdict;
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        const container = document.getElementById('infra-container');
        container.innerHTML = "";
        
        if (data.infrastructure && data.infrastructure.length > 0) {
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç—ã –ø–æ —Ç–∏–ø–∞–º
            const grouped = {};
            data.infrastructure.forEach(obj => {
                const type = obj.type || '–î—Ä—É–≥–æ–µ';
                if (!grouped[type]) {
                    grouped[type] = [];
                }
                grouped[type].push(obj);
            });
            
            // –ò–∫–æ–Ω–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const categoryIcons = {
                '–ú–∞–≥–∞–∑–∏–Ω': 'üõí',
                '–ê–ø—Ç–µ–∫–∞': 'üíä',
                '–ö–∞—Ñ–µ': '‚òï',
                '–ö–ª–∏–Ω–∏–∫–∞': 'üè•',
                '–û—Å—Ç–∞–Ω–æ–≤–∫–∞': 'üöå'
            };
            
            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—ã
            Object.keys(grouped).forEach(type => {
                const items = grouped[type];
                const icon = categoryIcons[type] || 'üìç';
                const categoryId = 'cat-' + type.toLowerCase().replace(/\s/g, '-');
                
                container.innerHTML += `
                    <div class="category-group">
                        <div class="category-header" onclick="toggleCategory('${categoryId}')">
                            <div class="category-title">
                                <span class="category-arrow" id="arrow-${categoryId}">‚ñ∂</span>
                                <span>${icon} ${type}—ã</span>
                                <span class="category-count">${items.length}</span>
                            </div>
                        </div>
                        <div class="category-items" id="${categoryId}">
                            ${items.map(obj => {
                                const name = obj.name.replace(type, '').replace(/^\s*\(|\)\s*$/g, '').trim() || type;
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                                const objLat = obj.lat || data.coords[0];
                                const objLon = obj.lon || data.coords[1];
                                return `
                                    <div class="infra-card">
                                        <span>${name}</span>
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <span class="infra-time">${obj.walk_time} –º–∏–Ω</span>
                                            <button class="location-btn" onclick="showOnMap(${objLat}, ${objLon})" title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ">üìç</button>
                                            <button class="details-btn" onclick="showPlaceDetails('${name.replace(/'/g, "\\'")}', ${objLat}, ${objLon})">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
        } else {
            container.innerHTML = "<p style='color: #70757a; font-size: 13px;'>–û–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ä–∞–¥–∏—É—Å–µ 15 –º–∏–Ω.</p>";
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–¥–∞–Ω–∏—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    loadBuildings();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    async function checkServerStatus() {
        try {
            const res = await fetch('http://127.0.0.1:8000/', { method: 'GET' });
            if (res.ok) {
                console.log('‚úÖ –°–µ—Ä–≤–µ—Ä CityVibe AI –ø–æ–¥–∫–ª—é—á–µ–Ω');
            } else {
                console.warn('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã');
            }
        } catch (e) {
            console.error('‚ùå –°–µ—Ä–≤–µ—Ä CityVibe –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏: python server.py');
        }
    }
    
    checkServerStatus();
</script>
</body>
</html>